# Apache2 Virtual Host configuration for Matrix Chat Support Widget
# Place this in /etc/apache2/sites-available/ and enable with a2ensite

<VirtualHost *:80>
    ServerName your-domain.com
    DocumentRoot /path/to/matrix-chat-support/dist/demo
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName your-domain.com
    DocumentRoot /path/to/matrix-chat-support/dist/demo
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    # SSLCertificateChainFile /path/to/your/chain.crt  # If you have a chain file
    
    # SSL Security
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS Headers for widget embedding
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    
    # Compression
    LoadModule deflate_module modules/mod_deflate.so
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|ico)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.pdf$ no-gzip dont-vary
    </Location>
    
    # Widget static files
    Alias /widget /path/to/matrix-chat-support/dist/widget
    <Directory "/path/to/matrix-chat-support/dist/widget">
        AllowOverride None
        Require all granted
        
        # Cache static assets
        ExpiresActive On
        ExpiresByType application/javascript "access plus 1 hour"
        ExpiresByType text/css "access plus 1 hour"
        ExpiresByType text/javascript "access plus 1 hour"
        
        # Security
        Header always set X-Content-Type-Options nosniff
    </Directory>
    
    # Proxy configuration for Node.js backend
    ProxyPreserveHost On
    ProxyRequests Off
    
    # API endpoints
    ProxyPass /api/ http://localhost:3001/api/
    ProxyPassReverse /api/ http://localhost:3001/api/
    
    # Embed script
    ProxyPass /embed.js http://localhost:3001/embed.js
    ProxyPassReverse /embed.js http://localhost:3001/embed.js
    
    # Health check
    ProxyPass /health http://localhost:3001/health
    ProxyPassReverse /health http://localhost:3001/health
    
    # Cache configuration for proxied content
    <LocationMatch "^/(api|embed\.js|health)">
        # API responses - no cache
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires 0
    </LocationMatch>
    
    <LocationMatch "^/embed\.js$">
        # Embed script - short cache
        Header always set Cache-Control "public, max-age=300"
    </LocationMatch>
    
    # Main document root for demo/admin interface
    <Directory "/path/to/matrix-chat-support/dist/demo">
        AllowOverride None
        Require all granted
        
        # SPA routing
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
        
        # Cache HTML files briefly
        <Files "*.html">
            ExpiresActive On
            ExpiresDefault "access plus 5 minutes"
        </Files>
        
        # Cache assets longer
        <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 month"
        </FilesMatch>
    </Directory>
    
    # Block access to sensitive files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    <FilesMatch "\.(yaml|yml|json)$">
        Require all denied
    </FilesMatch>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/matrix-chat-widget_error.log
    CustomLog ${APACHE_LOG_DIR}/matrix-chat-widget_access.log combined
    
    # Optional: Rate limiting with mod_evasive
    # LoadModule evasive24_module modules/mod_evasive24.so
    # <IfModule mod_evasive24.c>
    #     DOSHashTableSize    1024
    #     DOSPageCount        5
    #     DOSSiteCount        50
    #     DOSPageInterval     1
    #     DOSSiteInterval     1
    #     DOSBlockingPeriod   600
    # </IfModule>
</VirtualHost>

# Enable required Apache modules
# Run these commands:
# a2enmod rewrite
# a2enmod ssl
# a2enmod headers
# a2enmod expires
# a2enmod proxy
# a2enmod proxy_http